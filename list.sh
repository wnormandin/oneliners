# Check for the to 10 IPs by mod_security hit, log geoip data and the top 3 URIs hit
dt () { read tm; result=$(date +%s -d "$tm"); echo $result;}; start=$(echo "1 day ago" | dt); while IFS= read line; do time_stamp=$(echo "$line" | cut -d[ -f2 | cut -d] -f1 | dt ); if [ $time_stamp -gt $start ]; then echo $line; fi; done < <(grep "ModSecurity: Access denied" /usr/local/apache/logs/error_log) | tr -d '[' | awk -vFS="]" '$9 ~ /uri/{col=9}; $11 ~ /uri/{col=11};{print $3,$col}' | awk '{ printf "%s %s\n", $2, $4 }' | read data; top_10_ips=$(echo "$data" | cut -d' ' -f1 | sort | uniq -c | sort -n | tail -10); while IFS= read val; do ip=$(echo $val | cut -d' ' -f2 | tr -d ' '); ret_str="\n<<$val>>\n$(geoiplookup $ip)\nTop 3 URIs:\n$( grep "$ip" <<< "$data" | cut -d' ' -f2 | sort | uniq -c | sort -n | tail -3)"; echo -e "$ret_str"; done < <(echo "$top_10_ips" | tr -s " ") >> mod_sec_ip_hotlist.log &
